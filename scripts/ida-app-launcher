#!/bin/bash

set -euo pipefail

LOG_DIR="$HOME/.local/share/ida/logs"
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/ida-app-launcher.log"
{
  echo "---- $(date -Is) ----"
  echo "argv: $0 $*"
  echo "PATH: $PATH"
  echo "WAYLAND_DISPLAY: ${WAYLAND_DISPLAY:-} DISPLAY: ${DISPLAY:-}"
} >>"$LOG_FILE"

# Load config
CONFIG_FILE="$HOME/.config/ida/ida.conf"
HYPRLAND_CONFIG="$HOME/.config/hypr/programs.conf"

# First try to load from Hyprland config
if [ -f "$HYPRLAND_CONFIG" ]; then
  # Extract variables from Hyprland config
  # Hyprland config uses: `$terminal = alacritty`.
  # Avoid polluting the parent shell with `terminal`/`browser` commands by
  # parsing only the value part.
  terminal_from_hypr="$(sed -n 's/^\$terminal[[:space:]]*=[[:space:]]*//p' "$HYPRLAND_CONFIG" | head -n 1)"
  browser_from_hypr="$(sed -n 's/^\$browser[[:space:]]*=[[:space:]]*//p' "$HYPRLAND_CONFIG" | head -n 1)"

  # If found in Hyprland, use them
  [ -n "$terminal_from_hypr" ] && TERMINAL="$terminal_from_hypr"
  [ -n "$browser_from_hypr" ] && BROWSER="$browser_from_hypr"
fi

# Load local config (it has priority)
# NOTE: config uses quoted values (TERMINAL="alacritty"), so we source it.
[ -f "$CONFIG_FILE" ] && source "$CONFIG_FILE"

# Provide sensible defaults if user config is missing.
: "${TERMINAL:=alacritty}"
: "${TERMINAL_ARGS:=}"
: "${TERMINAL_CLASS:=}"
: "${BROWSER:=brave}"
: "${BROWSER_CLASS:=webapp}"
: "${BROWSER_ARGS:=}"
: "${WEBAPP_PROFILE_DIR:=$HOME/.local/share/webapps}"

# Determine launch type
MODE="${1:-}"
shift || true

ida__registry_file() {
  echo "${IDA_REGISTRY_FILE:-$HOME/.local/share/ida/apps.tsv}"
}

ida__list_apps() {
  local filter_type="${1:-}"
  local registry_file
  registry_file="$(ida__registry_file)"

  [ -f "$registry_file" ] || return 0

  if [ -n "$filter_type" ]; then
    awk -F'\t' -v t="$filter_type" '$2==t { printf "%-20s %-8s %s\n", $1, $2, $3 }' "$registry_file"
    return 0
  fi

  awk -F'\t' '{ printf "%-20s %-8s %s\n", $1, $2, $3 }' "$registry_file"
}

ida__remove_apps() {
  local app_name="${1:-}"
  local filter_type="${2:-}"
  local assume_yes="${3:-false}"

  local registry_file
  registry_file="$(ida__registry_file)"

  [ -f "$registry_file" ] || { echo "Registry not found: $registry_file" >&2; return 1; }

  mapfile -t matches < <(
    awk -F'\t' -v n="$app_name" -v t="$filter_type" '($1==n && (t=="" || $2==t)) { print $0 }' "$registry_file"
  )

  if [ "${#matches[@]}" -eq 0 ]; then
    echo "No registry entries found for: $app_name" >&2
    return 1
  fi

  if [ "$assume_yes" != "true" ]; then
    echo "Will remove:"
    printf '  %s\n' "${matches[@]}"

    if [ -t 0 ]; then
      local reply=""
      read -r -p "Proceed? [y/N] " reply
      case "${reply,,}" in y|yes) : ;; *) echo "Aborted." >&2; return 1 ;; esac
    else
      echo "Aborted (non-interactive). Use --yes." >&2
      return 1
    fi
  fi

  local changed="false"
  local line
  for line in "${matches[@]}"; do
    IFS=$'\t' read -r name type desktop_file icon_value created_at <<<"$line"

    if [ -n "$desktop_file" ] && [ -f "$desktop_file" ]; then
      rm -f "$desktop_file"
      changed="true"
    fi

    if [ -n "$icon_value" ]; then
      case "$icon_value" in
        "$HOME/.local/share/icons/ida"/*)
          if [ -f "$icon_value" ]; then
            rm -f "$icon_value"
            changed="true"
          fi
          ;;
      esac
    fi
  done

  awk -F'\t' -v n="$app_name" -v t="$filter_type" '!( $1==n && (t=="" || $2==t) )' "$registry_file" >"${registry_file}.tmp" || true
  mv -f "${registry_file}.tmp" "$registry_file"

  if [ "$changed" = "true" ]; then
    update-desktop-database ~/.local/share/applications >/dev/null 2>&1 || true
  fi

  echo "Removed: $app_name"
}

case "$MODE" in
--list-terminal)
  ida__list_apps "terminal"
  ;;
--list-webapp)
  ida__list_apps "webapp"
  ;;
--list)
  filter_type=""
  while [ "$#" -gt 0 ]; do
    case "$1" in
      --type)
        shift
        filter_type="${1:-}"
        ;;
      -h|--help)
        echo "Usage: ida-app-launcher --list [--type terminal|webapp]"
        exit 0
        ;;
      *)
        echo "Unknown argument: $1" >&2
        exit 1
        ;;
    esac
    shift
  done
  if [ -n "$filter_type" ] && [ "$filter_type" != "terminal" ] && [ "$filter_type" != "webapp" ]; then
    echo "Invalid --type: $filter_type" >&2
    exit 1
  fi
  ida__list_apps "$filter_type"
  ;;
--remove-terminal)
  app_name="${1:-}"
  if [ -z "$app_name" ] || [ "$app_name" = "-h" ] || [ "$app_name" = "--help" ]; then
    echo "Usage: ida-app-launcher --remove-terminal <name> [--yes]"
    exit 0
  fi
  shift || true
  assume_yes="false"
  while [ "$#" -gt 0 ]; do
    case "$1" in
      --yes|-y) assume_yes="true" ;;
      -h|--help) echo "Usage: ida-app-launcher --remove-terminal <name> [--yes]"; exit 0 ;;
      *) echo "Unknown argument: $1" >&2; exit 1 ;;
    esac
    shift
  done
  ida__remove_apps "$app_name" "terminal" "$assume_yes"
  ;;
--remove-webapp)
  app_name="${1:-}"
  if [ -z "$app_name" ] || [ "$app_name" = "-h" ] || [ "$app_name" = "--help" ]; then
    echo "Usage: ida-app-launcher --remove-webapp <name> [--yes]"
    exit 0
  fi
  shift || true
  assume_yes="false"
  while [ "$#" -gt 0 ]; do
    case "$1" in
      --yes|-y) assume_yes="true" ;;
      -h|--help) echo "Usage: ida-app-launcher --remove-webapp <name> [--yes]"; exit 0 ;;
      *) echo "Unknown argument: $1" >&2; exit 1 ;;
    esac
    shift
  done
  ida__remove_apps "$app_name" "webapp" "$assume_yes"
  ;;
--remove)
  app_name=""
  filter_type=""
  assume_yes="false"
  while [ "$#" -gt 0 ]; do
    case "$1" in
      --name)
        shift
        app_name="${1:-}"
        ;;
      --type)
        shift
        filter_type="${1:-}"
        ;;
      --yes|-y)
        assume_yes="true"
        ;;
      -h|--help)
        echo "Usage: ida-app-launcher --remove --name <name> [--type terminal|webapp] [--yes]"
        exit 0
        ;;
      *)
        echo "Unknown argument: $1" >&2
        exit 1
        ;;
    esac
    shift
  done
  if [ -z "$app_name" ]; then
    echo "Missing --name" >&2
    echo "Usage: ida-app-launcher --remove --name <name> [--type terminal|webapp] [--yes]" >&2
    exit 1
  fi
  if [ -n "$filter_type" ] && [ "$filter_type" != "terminal" ] && [ "$filter_type" != "webapp" ]; then
    echo "Invalid --type: $filter_type" >&2
    exit 1
  fi
  ida__remove_apps "$app_name" "$filter_type" "$assume_yes"
  ;;
terminal)
  # Run arbitrary/complex commands (pipes, quotes, etc.) safely via a shell.
  # Many terminals (kitty/alacritty/etc.) do not parse a single string with spaces
  # as a command; they expect argv. Using `sh -lc` makes it consistent.
  if [ "$#" -lt 1 ]; then
    echo "Usage: ida-app-launcher terminal <command>"
    exit 1
  fi

  COMMAND_STRING="$*"

  exec "$TERMINAL" $TERMINAL_ARGS $TERMINAL_CLASS -e sh -lc "$COMMAND_STRING"
  ;;
webapp)
  URL="$1"
  NAME="${2:-WebApp}"
  PROFILE="$WEBAPP_PROFILE_DIR/$NAME"

  mkdir -p "$PROFILE"

  case "$BROWSER" in
  firefox)
    exec firefox --class "$BROWSER_CLASS" --profile "$PROFILE" --new-instance "$URL"
    ;;
  chromium | google-chrome-stable)
    exec $BROWSER --class="$BROWSER_CLASS" --user-data-dir="$PROFILE" --app="$URL"
    ;;
  brave)
    exec brave --class="$BROWSER_CLASS" --app="$URL"
    ;;
  *)
    exec $BROWSER "$URL"
    ;;
  esac
  ;;
*)
  echo "Usage: ida-app-launcher {terminal|webapp|--list|--list-terminal|--list-webapp|--remove|--remove-terminal|--remove-webapp} [arguments]"
  exit 1
  ;;
esac
