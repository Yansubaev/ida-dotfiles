#!/usr/bin/env bash
set -euo pipefail

cache_base="$HOME/.cache/ida-theme"
current_dir="$cache_base/current"

if [[ ! -d "$current_dir" ]]; then
  echo "Theme not generated yet: $current_dir" >&2
  exit 1
fi

# Hyprland: source this from hyprland config (we keep it in ~/.config/hypr/ida-theme.conf)
mkdir -p "$HOME/.config/hypr"
ln -sf "$current_dir/hyprland-colors.conf" "$HOME/.config/hypr/ida-theme.conf"

# Waybar: import colors into style
mkdir -p "$HOME/.config/waybar"
ln -sf "$current_dir/waybar-colors.css" "$HOME/.config/waybar/colors.css"

# Wofi: wofi CSS support may not support @import reliably.
# Provide a full style.css generated by wallust.
mkdir -p "$HOME/.config/wofi"
ln -sf "$current_dir/wofi-style.css" "$HOME/.config/wofi/style.css"

# Terminals configs (optional, if user uses them)
# Alacritty
ln -sf "$current_dir/alacritty.toml" "$HOME/.config/alacritty/theme.toml"

# Kitty
ln -sf "$current_dir/kitty.conf" "$HOME/.config/kitty/theme.conf"

# Ghostty
ln -sf "$current_dir/ghostty.conf" "$HOME/.config/ghostty/theme.conf"

# Fish shell colors (syntax highlighting)
mkdir -p "$HOME/.config/fish"
ln -sf "$current_dir/fish-theme.fish" "$HOME/.config/fish/ida-theme.fish"
ln -sf "$current_dir/ida-git-colors.fish" "$HOME/.config/fish/ida-git-colors.fish"

# GTK: we can't force a theme universally, but we can provide a css snippet.
mkdir -p "$HOME/.config/gtk-4.0" "$HOME/.config/gtk-3.0"
ln -sf "$current_dir/gtk.css" "$HOME/.config/gtk-4.0/ida-colors.css"
ln -sf "$current_dir/gtk.css" "$HOME/.config/gtk-3.0/ida-colors.css"

# Qt: expose vars for scripts; qt5ct/qt6ct/kvantum need separate configuration.
mkdir -p "$HOME/.config/ida-theme"
ln -sf "$current_dir/qt.conf" "$HOME/.config/ida-theme/qt.conf"

# Reload running components
if command -v hyprctl >/dev/null 2>&1; then
  hyprctl reload >/dev/null 2>&1 || true
fi

# Restart waybar if running
if pgrep -x waybar >/dev/null 2>&1; then
  pkill -x waybar || true
  (nohup waybar >/dev/null 2>&1 &)
fi

# Nothing to restart for wofi (it is spawned on demand)

echo "Applied theme from: $current_dir"
