#!/usr/bin/env bash
set -euo pipefail

repo_root="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"

hyprpaper_conf_src="$repo_root/config/hypr/hyprpaper.conf"

if [[ ! -f "$hyprpaper_conf_src" ]]; then
  echo "hyprpaper.conf not found: $hyprpaper_conf_src" >&2
  exit 1
fi

# Extract wallpaper path from the first matching `preload = ...` or `path = ...` line.
wallpaper_rel="$(
  awk -F= '
    $1 ~ /^[[:space:]]*(preload|path)[[:space:]]*$/ {
      gsub(/^[[:space:]]+|[[:space:]]+$/, "", $2);
      print $2;
      exit
    }
  ' "$hyprpaper_conf_src"
)"

if [[ -z "${wallpaper_rel:-}" ]]; then
  echo "Failed to extract wallpaper path from: $hyprpaper_conf_src" >&2
  exit 1
fi

# Expand ~ and make it absolute.
wallpaper="$wallpaper_rel"
if [[ "$wallpaper" == ~* ]]; then
  wallpaper="$HOME${wallpaper:1}"
fi

if [[ ! "$wallpaper" = /* ]]; then
  # Treat relative as repo relative.
  wallpaper="$repo_root/$wallpaper"
fi

if [[ ! -f "$wallpaper" ]]; then
  echo "Wallpaper file not found: $wallpaper" >&2
  exit 1
fi

if ! command -v wallust >/dev/null 2>&1; then
  echo "wallust not found in PATH" >&2
  exit 1
fi

cache_base="$HOME/.cache/ida-theme"
current_dir="$cache_base/current"
history_dir="$cache_base/themes"

mkdir -p "$current_dir" "$history_dir"

# Run wallust with our repo config, emit generated files into current_dir.
wallust run -q -C "$repo_root/config/wallust/wallust.toml" --templates-dir "$repo_root/config/wallust/templates" "$wallpaper"

# current_dir must now contain generated files.
if [[ ! -f "$current_dir/theme.json" ]]; then
  echo "wallust did not generate expected file: $current_dir/theme.json" >&2
  exit 1
fi

# Theme id: based on file basename + sha1 to avoid clashes
wallpaper_base="$(basename "$wallpaper")"
wallpaper_sha="$(sha1sum "$wallpaper" | awk '{print $1}')"
theme_id="${wallpaper_base%.*}-${wallpaper_sha:0:8}"

theme_dir="$history_dir/$theme_id"
if [[ ! -d "$theme_dir" ]]; then
  mkdir -p "$theme_dir"
  cp -a "$current_dir/." "$theme_dir/"
fi

# Write pointer to current theme
printf '%s\n' "$theme_id" > "$cache_base/current-theme"

# Optional: also export to repo themes/generated for packaging/review
repo_generated_dir="$repo_root/themes/generated"
mkdir -p "$repo_generated_dir"
cp -a "$current_dir/." "$repo_generated_dir/"

# Print summary for manual runs
printf 'wallpaper=%s\n' "$wallpaper"
printf 'theme_id=%s\n' "$theme_id"
printf 'current=%s\n' "$current_dir"
printf 'saved=%s\n' "$theme_dir"
