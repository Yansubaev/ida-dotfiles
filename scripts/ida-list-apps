#!/bin/bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}" )" && pwd)"
# shellcheck source=./ida-app-lib.sh
source "$SCRIPT_DIR/ida-app-lib.sh"

REGISTRY_FILE="${IDA_REGISTRY_FILE:-$IDA_REGISTRY_DEFAULT}"

usage() {
  echo "Usage: ida-list-apps [--type terminal|webapp] [--raw]"
}

FILTER_TYPE=""
RAW="false"

while [ "$#" -gt 0 ]; do
  case "$1" in
    --type)
      shift
      FILTER_TYPE="${1:-}"
      ;;
    --raw)
      RAW="true"
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "Unknown argument: $1" >&2
      usage
      exit 1
      ;;
  esac
  shift
done

if [ ! -f "$REGISTRY_FILE" ]; then
  exit 0
fi

if [ "$RAW" = "true" ]; then
  if [ -n "$FILTER_TYPE" ]; then
    awk -F'\t' -v t="$FILTER_TYPE" '$2==t' "$REGISTRY_FILE"
  else
    cat "$REGISTRY_FILE"
  fi
  exit 0
fi

# Pretty output
awk -F'\t' -v t="$FILTER_TYPE" '
  BEGIN { OFS="\t" }
  (t=="" || $2==t) {
    printf "%-20s %-8s %s\n", $1, $2, $3
  }
' "$REGISTRY_FILE"
