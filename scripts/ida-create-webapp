#!/bin/bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
APP_LAUNCHER_DIR="$SCRIPT_DIR/app-launcher"
# shellcheck source=./app-launcher/ida-app-lib.sh
source "$APP_LAUNCHER_DIR/ida-app-lib.sh"

APP_NAME="${1:-}"
URL="${2:-}"
shift $(($# > 0 ? 1 : 0))
shift $(($# > 0 ? 1 : 0))

ICON_SPEC=""
CATEGORY="Network"

usage() {
  echo "Usage: ida-create-webapp <name> <URL> [--icon <path|url|theme>] [--category <category>]"
}

while [ "$#" -gt 0 ]; do
  case "$1" in
  --icon)
    shift
    ICON_SPEC="${1:-}"
    ;;
  --category)
    shift
    CATEGORY="${1:-Network}"
    ;;
  -h | --help)
    usage
    exit 0
    ;;
  *)
    echo "Unknown argument: $1" >&2
    usage
    exit 1
    ;;
  esac
  shift
done

if [ -z "$APP_NAME" ] || [ -z "$URL" ]; then
  usage
  exit 1
fi

DESKTOP_FILE="$HOME/.local/share/applications/${APP_NAME}.desktop"

ICON_VALUE=""
if [ -n "$ICON_SPEC" ]; then
  ICON_VALUE="$(ida_resolve_icon "$APP_NAME" "$ICON_SPEC")"
else
  ICON_VALUE="applications-internet"
fi

LAUNCHER_BIN="${IDA_LAUNCHER_BIN:-$HOME/.local/bin/ida-app-launcher}"

cat >"$DESKTOP_FILE" <<EOF
[Desktop Entry]
Type=Application
Name=$APP_NAME
Exec=$LAUNCHER_BIN webapp "$URL" "$APP_NAME"
Icon=$ICON_VALUE
Terminal=false
Categories=$CATEGORY;
StartupWMClass=webapp
X-IDA-Managed=true
X-IDA-Type=webapp
X-IDA-Name=$APP_NAME
EOF

ida_registry_add "$APP_NAME" "webapp" "$DESKTOP_FILE" "$ICON_VALUE"

update-desktop-database ~/.local/share/applications
echo "Created WebApp: $DESKTOP_FILE"
