#!/bin/bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=./ida-app-lib.sh
source "$SCRIPT_DIR/ida-app-lib.sh"

APP_NAME="${1:-}"
COMMAND="${2:-}"
shift $(($# > 0 ? 1 : 0))
shift $(($# > 0 ? 1 : 0))

ICON_SPEC=""
CATEGORY="Utility"

usage() {
  echo "Usage: ida-create-terminal-app <name> <command> [--icon <path|url|theme>] [--category <category>]"
}

while [ "$#" -gt 0 ]; do
  case "$1" in
  --icon)
    shift
    ICON_SPEC="${1:-}"
    ;;
  --category)
    shift
    CATEGORY="${1:-Utility}"
    ;;
  -h | --help)
    usage
    exit 0
    ;;
  *)
    echo "Unknown argument: $1" >&2
    usage
    exit 1
    ;;
  esac
  shift
done

if [ -z "$APP_NAME" ] || [ -z "$COMMAND" ]; then
  usage
  exit 1
fi

DESKTOP_FILE="$HOME/.local/share/applications/${APP_NAME}.desktop"

ICON_VALUE=""
if [ -n "$ICON_SPEC" ]; then
  ICON_VALUE="$(ida_resolve_icon "$APP_NAME" "$ICON_SPEC")"
fi

# Desktop files don't do shell parsing. We pass the whole command as a single
# argument and let `ida-app-launcher terminal` run it via `sh -lc`.
# Quote the command as one argument for Exec=.
COMMAND_ONE_ARG="\"$COMMAND\""

LAUNCHER_BIN="${IDA_LAUNCHER_BIN:-$HOME/.local/bin/ida-app-launcher}"

{
  echo "[Desktop Entry]"
  echo "Type=Application"
  echo "Name=$APP_NAME"
  echo "Exec=$LAUNCHER_BIN terminal $COMMAND_ONE_ARG"
  if [ -n "$ICON_VALUE" ]; then
    echo "Icon=$ICON_VALUE"
  fi
  echo "Terminal=false"
  echo "Categories=$CATEGORY;"
  echo "StartupWMClass=floating-term"
  echo "X-IDA-Managed=true"
  echo "X-IDA-Type=terminal"
  echo "X-IDA-Name=$APP_NAME"
} >"$DESKTOP_FILE"

ida_registry_add "$APP_NAME" "terminal" "$DESKTOP_FILE" "$ICON_VALUE"

update-desktop-database ~/.local/share/applications
echo "Created terminal app: $DESKTOP_FILE"
